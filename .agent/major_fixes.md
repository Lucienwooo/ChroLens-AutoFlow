# AutoFlow 重大修復總結

## 🔧 修復的問題

### 問題 1：使用廠商代碼而非女優名稱 ❌

**原因：**

- 快取中儲存了廠商代碼（SSIS, SONE, MIDV 等）
- 系統直接使用快取值而不驗證
- 沒有實際執行 JavBus 搜尋

**日誌範例（錯誤）：**

```
[22:17:30]   番號: SSIS-945
[22:17:30]   [快取] SSIS
[22:17:30]   [完成] -> SSIS\
```

---

## ✅ 實施的修復

### 1. 快取驗證機制

```python
# 檢查快取，但只接受女優名稱（非廠商代碼）
if code in self.cache:
    cached_value = self.cache[code]
    # 檢查是否為廠商代碼（全大寫且長度 <= 10）
    if cached_value and len(cached_value) <= 10 and cached_value.isupper():
        # 這是廠商代碼，重新搜尋
        self.log_update.emit(f"  [快取無效] {cached_value} (廠商代碼)")
        actress = self.search_actress(code)
```

### 2. 移除廠商分類備用方案

```python
# 修改前
studio = self._get_studio_from_code(code)
if studio:
    return studio

# 修改後
# 沒有找到女優名稱
return None
```

### 3. 跳過未找到女優的影片

```python
# 如果沒有找到女優名稱，跳過
if not actress or actress in ["UNKNOWN", "MULTIPLE"]:
    self.log_update.emit(f"  [跳過] 未找到女優名稱")
    skipped += 1
    continue
```

### 4. 檢查檔案是否已在正確資料夾

```python
# 檢查檔案是否已經在正確的資料夾中
current_folder = file_path.parent.name
if current_folder == actress:
    self.log_update.emit(f"  [已分類] 檔案已在 {actress} 資料夾中")
    skipped += 1
    continue
```

### 5. 清理快取工具

- 創建 `清理快取.py`
- 自動移除廠商代碼
- 備份原始快取

---

## 📊 預期效果

### 修復前（錯誤）

```
[22:17:28]   番號: STARS-947
[22:17:28]   [快取] STARS      ❌ 廠商代碼
[22:17:28]   [完成] -> STARS\  ❌ 錯誤分類
```

### 修復後（正確）

```
[XX:XX:XX]   番號: STARS-947
[XX:XX:XX]   [快取無效] STARS (廠商代碼)
[XX:XX:XX]   搜尋中...
[XX:XX:XX]   [找到] 神木麗     ✓ 女優名稱
[XX:XX:XX]   [完成] -> 神木麗\ ✓ 正確分類
```

### 未找到女優時

```
[XX:XX:XX]   番號: CUS-2013
[XX:XX:XX]   搜尋中...
[XX:XX:XX]   [JavBus] 未找到資料
[XX:XX:XX]   [未找到] 無法取得女優資訊
[XX:XX:XX]   [跳過] 未找到女優名稱  ✓ 不移動檔案
```

### 檔案已在正確資料夾

```
[XX:XX:XX]   番號: STARS-947
[XX:XX:XX]   [快取] 神木麗
[XX:XX:XX]   [已分類] 檔案已在 神木麗 資料夾中  ✓ 不重複移動
```

---

## 🚀 使用步驟

### 步驟 1：清理舊快取

```bash
python 清理快取.py
```

這會：

- 移除所有廠商代碼
- 移除 UNKNOWN/MULTIPLE
- 備份原始快取

### 步驟 2：重新啟動 AutoFlow

```bash
測試運行.bat
```

### 步驟 3：處理影片

1. 選擇資料夾
2. (可選) 勾選「包含子資料夾」
3. 點擊「開始」
4. 觀察日誌

---

## 💡 關鍵改進

### 1. 只使用女優名稱

- ✅ 不再使用廠商代碼
- ✅ 驗證快取值
- ✅ 重新搜尋無效快取

### 2. 找不到就跳過

- ✅ 不移動檔案
- ✅ 清楚的日誌訊息
- ✅ 避免錯誤分類

### 3. 避免重複處理

- ✅ 檢查當前資料夾名稱
- ✅ 已分類的檔案不再移動
- ✅ 節省處理時間

### 4. 子資料夾智能處理

- ✅ 遞迴搜尋所有子資料夾
- ✅ 檢查子資料夾名稱
- ✅ 只移動需要分類的檔案

---

## 📋 處理邏輯流程

```
1. 掃描影片檔案
   ↓
2. 提取番號
   ↓
3. 檢查快取
   ├─ 有效女優名稱 → 使用
   └─ 廠商代碼 → 重新搜尋
   ↓
4. JavBus 搜尋
   ├─ 找到女優 → 繼續
   └─ 未找到 → 跳過
   ↓
5. 檢查當前位置
   ├─ 已在正確資料夾 → 跳過
   └─ 需要移動 → 移動
   ↓
6. 移動到女優資料夾
```

---

## ⚠️ 注意事項

1. **首次運行**
   - 需要清理舊快取
   - 會重新搜尋所有影片
   - 可能需要較長時間

2. **網路需求**
   - 需要訪問 JavBus
   - 建議穩定網路連線

3. **未找到的影片**
   - 不會被移動
   - 保留在原位置
   - 可手動處理

---

## 🎯 測試建議

### 測試案例 1：新影片

- 選擇包含未分類影片的資料夾
- 確認搜尋女優名稱
- 確認建立女優資料夾

### 測試案例 2：已分類影片

- 選擇已有女優資料夾的目錄
- 勾選「包含子資料夾」
- 確認不重複移動

### 測試案例 3：找不到的影片

- 包含一些冷門番號
- 確認跳過處理
- 檔案保留原位

---

**修復完成！請先執行 `清理快取.py` 然後重新測試！** 🎉
