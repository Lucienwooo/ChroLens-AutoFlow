# -*- coding: utf-8 -*-
"""
AutoFlow - ?能影個檔案??工具
?本: 1.0.0
作? Lucien
??: GPL v3 + Commercial
"""

import sys
import os
import json
import re
import time
import subprocess
from pathlib import Path
from PyQt6.QtWidgets import (QApplication, QMainWindow, QWidget, QVBoxLayout, 
                              QHBoxLayout, QPushButton, QLabel, QTextEdit, 
                              QProgressBar, QFileDialog, QFrame, QScrollArea,
                              QListWidget, QListWidgetItem, QSplitter, QDialog,
                              QCheckBox, QMessageBox, QInputDialog, QGridLayout)
from PyQt6.QtCore import Qt, QThread, pyqtSignal, QSize, QSettings, QPoint, QTimer
from PyQt6.QtGui import QFont, QColor, QPalette, QPixmap, QImage, QIcon, QCursor
import requests
import cv2
import numpy as np

# 導入?本管個檔案
try:
    from version_manager import VersionManager
    from version_info_dialog import VersionInfoDialog
    from about import AboutDialog
    from multi_player import MultiPlayerWindow
except ImportError:
    VersionManager = None
    AboutDialog = None
    MultiPlayerWindow = None

VERSION = "1.0.0"
APP_NAME = "AutoFlow"
FULL_APP_NAME = "ChroLens_AutoFlow"
GITHUB_REPO = "Lucienwooo/ChroLens_AutoFlow"


class VideoProcessor(QThread):
    progress_update = pyqtSignal(int, int, int, int)
    log_update = pyqtSignal(str)
    current_file_update = pyqtSignal(str)
    finished = pyqtSignal()
    
    def __init__(self, folder_path, cache):
        super().__init__()
        self.folder_path = folder_path
        self.cache = cache
        self.is_running = True
        
    def run(self):
        self.log_update.emit("=== 個檔案? ===")
        
        files = list(Path(self.folder_path).glob("*.mp4"))
        total = len(files)
        processed = 0
        skipped = 0
        failed = 0
        
        self.log_update.emit(f"找到 {total} 個影片檔案")
        
        # 先清理重複檔案
        files = self.remove_duplicate_files(files)
        total = len(files)
        self.log_update.emit(f"清理重複檔案後剩餘 {total} 個檔案")
        
        for i, file_path in enumerate(files):
            if not self.is_running:
                break
                
            self.current_file_update.emit(f"個檔案: {file_path.name}")
            
            code = self.extract_video_code(file_path.name)
            if not code:
                self.log_update.emit(f"[跳過] {file_path.name} - 個檔案個檔案")
                skipped += 1
                self.progress_update.emit(total, processed, skipped, failed)
                continue
            
            self.log_update.emit(f"[{i+1}/{total}] {file_path.name}")
            self.log_update.emit(f"  ??: {code}")
            
            if code in self.cache:
                actress = self.cache[code]
                self.log_update.emit(f"  [快?] {actress}")
            else:
                actress = self.search_actress(code)
                if actress:
                    self.cache[code] = actress
                else:
                    self.log_update.emit(f"  [失?] ??失?")
                    failed += 1
                    self.progress_update.emit(total, processed, skipped, failed)
                    continue
                
                time.sleep(2)
            
            if actress in ["UNKNOWN", "MULTIPLE"]:
                self.log_update.emit(f"  [跳過] {actress}")
                skipped += 1
                self.progress_update.emit(total, processed, skipped, failed)
                continue
            
            if self.move_video_file(file_path, actress):
                self.log_update.emit(f"  [完?] -> {actress}\\")
                processed += 1
            else:
                skipped += 1
            
            self.progress_update.emit(total, processed, skipped, failed)
            
            if (i + 1) % 5 == 0:
                self.save_cache()
        
        self.save_cache()
        self.log_update.emit("=== ??完? ===")
        self.finished.emit()
    
    def remove_duplicate_files(self, files):
        """
        移除個檔案?
        1. ?除帶? (1), (2) 等?綴個檔案檔案
        2. 個檔案個檔案MOSAIC-ARCHIVE-XXX ??XXX，個檔案MOSAIC-ARCHIVE ?本
        """
        files_to_keep = []
        files_to_remove = []
        
        # 建?檔個檔案?{個檔案稱: [檔案路??表]}
        file_groups = {}
        
        for file_path in files:
            stem = file_path.stem
            
            # 移除 (1), (2) 等??
            base_name = re.sub(r'\s*\(\d+\)$', '', stem)
            
            # 移除 MOSAIC-ARCHIVE- ?綴以進個檔案
            group_key = re.sub(r'^(A-)?MOSAIC-ARCHIVE-', '', base_name, flags=re.IGNORECASE)
            group_key = re.sub(r'^ARCHIVE-MOSAIC-', '', group_key, flags=re.IGNORECASE)
            group_key = group_key.upper()
            
            if group_key not in file_groups:
                file_groups[group_key] = []
            
            file_groups[group_key].append({
                'path': file_path,
                'stem': stem,
                'base_name': base_name,
                'has_number_suffix': bool(re.search(r'\(\d+\)$', stem)),
                'has_mosaic_prefix': bool(re.match(r'^(A-)?MOSAIC-ARCHIVE-', stem, re.IGNORECASE))
            })
        
        # ??每個??
        for group_key, group_files in file_groups.items():
            if len(group_files) == 1:
                # ??一??案??接保?
                files_to_keep.append(group_files[0]['path'])
            else:
                # 多個?案??要選個檔案哪一??
                # ??級?
                # 1. 沒? (1)(2) 後綴??
                # 2. ??MOSAIC-ARCHIVE ?綴??
                
                # ??濾??數字?綴?
                no_suffix_files = [f for f in group_files if not f['has_number_suffix']]
                
                if no_suffix_files:
                    # 個檔案數字?綴?檔案中個檔案個檔案?MOSAIC-ARCHIVE ??
                    mosaic_files = [f for f in no_suffix_files if f['has_mosaic_prefix']]
                    
                    if mosaic_files:
                        # 保?第個檔案MOSAIC-ARCHIVE 檔案
                        files_to_keep.append(mosaic_files[0]['path'])
                        # 個檔案刪??
                        for f in group_files:
                            if f['path'] != mosaic_files[0]['path']:
                                files_to_remove.append(f['path'])
                    else:
                        # 沒? MOSAIC-ARCHIVE，??第一?無後綴??
                        files_to_keep.append(no_suffix_files[0]['path'])
                        for f in group_files:
                            if f['path'] != no_suffix_files[0]['path']:
                                files_to_remove.append(f['path'])
                else:
                    # ?部個檔案?後綴，??第一??
                    files_to_keep.append(group_files[0]['path'])
                    for f in group_files[1:]:
                        files_to_remove.append(f['path'])
        
        # 個檔案除
        for file_path in files_to_remove:
            try:
                file_path.unlink()
                self.log_update.emit(f"[清?] 已刪??複?? {file_path.name}")
            except Exception as e:
                self.log_update.emit(f"[錯誤] 個檔案除 {file_path.name}: {e}")
        
        return files_to_keep
    
    def extract_video_code(self, filename):
        name = Path(filename).stem
        name = re.sub(r'^(A-)?MOSAIC-ARCHIVE-', '', name, flags=re.IGNORECASE)
        name = re.sub(r'^ARCHIVE-MOSAIC-', '', name, flags=re.IGNORECASE)
        name = re.sub(r'^CHIVE-MOSAIC[_-]', '', name, flags=re.IGNORECASE)
        name = re.sub(r'(-UB|-ub)(\s+\(\d+\))?$', '', name)
        name = re.sub(r'\s+\(\d+\)$', '', name)
        
        match = re.match(r'^([A-Z]+-\d+)', name, re.IGNORECASE)
        if match:
            return match.group(1).upper()
        
        match = re.match(r'^(\d+[A-Z]+-\d+)', name, re.IGNORECASE)
        if match:
            return match.group(1).upper()
        
        match = re.search(r'(FC2-?PPV-\d+)', name, re.IGNORECASE)
        if match:
            return match.group(1).upper().replace('FC2PPV', 'FC2-PPV')
        
        match = re.match(r'^([a-z]+-\d+)', name, re.IGNORECASE)
        if match:
            return match.group(1).upper()
        
        return None
    
    def search_actress(self, code):
        # 檢查是否為FC2影片
        if code.upper().startswith('FC2'):
            self.log_update.emit(f"  [FC2] 分類到FC2資料夾")
            return "FC2"
        
        self.log_update.emit(f"  搜尋中...")
        
        try:
            url = f"https://av-wiki.net/{code}"
            headers = {'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'}
            response = requests.get(url, headers=headers, timeout=15)
            html = response.text
            
            match = re.search(r'演員[?]\s*<[^>]*>([^<]+)</', html)
            if match:
                actress = match.group(1).strip()
                self.log_update.emit(f"  [找到] {actress}")
                return actress
            
            match = re.search(r'actress[^>]*>([^<]+)</a>', html)
            if match and not re.match(r'^(Featured|Actress|女優)', match.group(1)):
                actress = match.group(1).strip()
                self.log_update.emit(f"  [找到] {actress}")
                return actress
            
            jp_matches = re.findall(r'[\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FFF]{2,8}', html)
            if jp_matches:
                filtered = [m for m in jp_matches if not re.match(
                    r'^(??|影?|女優|演員|作?|系?|??|??|??|標籤|評?|觀?|下?|??|?享|??|?薦|??|??|??|??|??|首?|?於|?絡)$', m
                )]
                if filtered:
                    actress = filtered[0]
                    self.log_update.emit(f"  [找到] {actress}")
                    return actress
            
            return "UNKNOWN"
            
        except Exception as e:
            self.log_update.emit(f"  [錯誤] {str(e)}")
            return None
    
    def move_video_file(self, file_path, actress_name):
        try:
            clean_name = actress_name.strip()
            for char in '<>:"/\\|?*':
                clean_name = clean_name.replace(char, '_')
            
            target_folder = Path(self.folder_path) / clean_name
            target_folder.mkdir(exist_ok=True)
            
            target_path = target_folder / file_path.name
            if target_path.exists():
                self.log_update.emit(f"  [跳過] 檔案已個檔案)")
                return False
            
            file_path.rename(target_path)
            return True
            
        except Exception as e:
            self.log_update.emit(f"  [錯誤] {str(e)}")
            return False
    
    def save_cache(self):
        cache_file = Path.home() / "Downloads" / "actress_cache.json"
        try:
            with open(cache_file, 'w', encoding='utf-8') as f:
                json.dump(self.cache, f, ensure_ascii=False, indent=2)
        except Exception as e:
            self.log_update.emit(f"快個檔案失?: {str(e)}")
    
    def stop(self):
        self.is_running = False


class VideoListItem(QWidget):
    deleted = pyqtSignal(object)  # 刪除信?
    renamed = pyqtSignal(object)  # ?命?信??
    
    def __init__(self, video_path, is_dark=False, parent_window=None):
        super().__init__()
        self.video_path = video_path
        self.is_dark = is_dark
        self.parent_window = parent_window
        self.video_capture = None
        self.total_frames = 0
        self.fps = 0
        
        # 個檔案影個檔案
        try:
            cap = cv2.VideoCapture(str(self.video_path))
            self.total_frames = int(cap.get(cv2.CAP_PROP_FRAME_COUNT))
            self.fps = cap.get(cv2.CAP_PROP_FPS)
            cap.release()
        except:
            pass
        
        # 主?局（水平?局：左?縮個檔案側個檔案
        main_layout = QHBoxLayout()
        main_layout.setContentsMargins(8, 8, 8, 8)
        main_layout.setSpacing(8)
        
        # 左側：縮個檔案
        left_layout = QVBoxLayout()
        left_layout.setSpacing(4)
        
        # 縮? - ?用滑?追蹤以實?即??覽?寬度x2，?度x1?
        self.thumbnail_label = QLabel()
        self.thumbnail_label.setFixedSize(320, 180)
        bg_color = "#2C2C2E" if is_dark else "#E5E5EA"
        self.thumbnail_label.setStyleSheet(f"background-color: {bg_color}; border-radius: 6px;")
        self.thumbnail_label.setScaledContents(True)
        self.thumbnail_label.setMouseTracking(True)  # ?用滑?追蹤
        self.thumbnail_label.installEventFilter(self)  # 安?事件?濾??
        
        # 載入??縮?
        self.load_thumbnail()
        
        # ?度條?跟隨滑?顯示?度?
        self.progress_bar = QProgressBar()
        self.progress_bar.setFixedSize(320, 4)
        self.progress_bar.setTextVisible(False)
        self.progress_bar.setRange(0, 100)
        self.progress_bar.setValue(0)
        progress_color = "#007AFF" if is_dark else "#0066CC"
        self.progress_bar.setStyleSheet(f"""
            QProgressBar {{
                border: none;
                border-radius: 2px;
                background-color: {bg_color};
            }}
            QProgressBar::chunk {{
                background-color: {progress_color};
                border-radius: 2px;
            }}
        """)
        
        # 檔案
        self.filename_label = QLabel(video_path.name)
        text_color = "#E5E5EA" if is_dark else "#1C1C1E"
        self.filename_label.setStyleSheet(f"font-size: 10px; color: {text_color};")
        self.filename_label.setWordWrap(True)
        self.filename_label.setAlignment(Qt.AlignmentFlag.AlignCenter)
        self.filename_label.setMaximumWidth(320)
        
        left_layout.addWidget(self.thumbnail_label)
        left_layout.addWidget(self.progress_bar)
        left_layout.addWidget(self.filename_label)
        
        # ?側：??群組?緊鄰縮??側?
        button_layout = QVBoxLayout()
        button_layout.setSpacing(4)
        button_layout.setAlignment(Qt.AlignmentFlag.AlignTop)
        button_layout.setContentsMargins(0, 0, 0, 0)
        
        # 個檔案?
        self.open_btn = QPushButton("?? ??")
        self.open_btn.setFixedSize(60, 32)
        self.open_btn.setStyleSheet(self.get_button_style("#34C759"))
        self.open_btn.clicked.connect(self.open_video)
        
        # 個檔案?
        self.rename_btn = QPushButton("?? ??")
        self.rename_btn.setFixedSize(60, 32)
        self.rename_btn.setStyleSheet(self.get_button_style("#007AFF"))
        self.rename_btn.clicked.connect(self.rename_video)
        
        # 刪除??
        self.delete_btn = QPushButton("個檔案?除")
        self.delete_btn.setFixedSize(60, 32)
        self.delete_btn.setStyleSheet(self.get_button_style("#FF3B30"))
        self.delete_btn.clicked.connect(self.delete_video)
        
        button_layout.addWidget(self.open_btn)
        button_layout.addWidget(self.rename_btn)
        button_layout.addWidget(self.delete_btn)
        button_layout.addStretch()
        
        main_layout.addLayout(left_layout)
        main_layout.addLayout(button_layout)
        
        self.setLayout(main_layout)
    
    def get_button_style(self, color):
        """個檔案個檔案"""
        return f"""
            QPushButton {{
                background-color: {color};
                color: white;
                border: none;
                border-radius: 4px;
                font-size: 10px;
                font-weight: 600;
            }}
            QPushButton:hover {{
                opacity: 0.8;
            }}
        """
    
    def eventFilter(self, obj, event):
        """事件?濾??- 實現滑個檔案個檔案覽"""
        if obj == self.thumbnail_label:
            if event.type() == event.Type.MouseMove:
                # ??滑??縮個檔案??
                pos = event.pos()
                width = self.thumbnail_label.width()
                
                # 計??度個檔案
                progress = pos.x() / width
                progress = max(0.0, min(1.0, progress))  # ?制??0-1 之?
                
                # ?新?度?
                self.progress_bar.setValue(int(progress * 100))
                
                # 載入對??度?畫??
                self.load_frame_at_progress(progress)
                return True
            
            elif event.type() == event.Type.Leave:
                # 滑個檔案?恢復?始縮個檔案度?
                self.load_thumbnail()
                self.progress_bar.setValue(0)
                return True
            
            elif event.type() == event.Type.MouseButtonPress:
                # 個檔案放影片
                if event.button() == Qt.MouseButton.LeftButton:
                    self.open_video()
                    return True
            
            elif event.type() == event.Type.MouseButtonPress:
                # ?鍵?接?放影片
                if event.button() == Qt.MouseButton.RightButton:
                    self.open_video()
                    return True
        
        return super().eventFilter(obj, event)
    
    def load_frame_at_progress(self, progress):
        """載入個檔案度個影片畫??""
        if self.total_frames == 0:
            return
        
        try:
            cap = cv2.VideoCapture(str(self.video_path))
            
            # 計個檔案幀??
            target_frame = int(self.total_frames * progress)
            cap.set(cv2.CAP_PROP_POS_FRAMES, target_frame)
            
            ret, frame = cap.read()
            cap.release()
            
            if ret:
                frame = cv2.cvtColor(frame, cv2.COLOR_BGR2RGB)
                h, w, ch = frame.shape
                bytes_per_line = ch * w
                qt_image = QImage(frame.data, w, h, bytes_per_line, QImage.Format.Format_RGB888)
                pixmap = QPixmap.fromImage(qt_image)
                self.thumbnail_label.setPixmap(pixmap.scaled(320, 180, Qt.AspectRatioMode.KeepAspectRatio, Qt.TransformationMode.SmoothTransformation))
        except Exception as e:
            print(f"載入?面失?: {e}")
    
    def load_thumbnail(self):
        """載入??縮? (??"""
        try:
            cap = cv2.VideoCapture(str(self.video_path))
            cap.set(cv2.CAP_PROP_POS_MSEC, 5000)
            ret, frame = cap.read()
            cap.release()
            
            if ret:
                frame = cv2.cvtColor(frame, cv2.COLOR_BGR2RGB)
                h, w, ch = frame.shape
                bytes_per_line = ch * w
                qt_image = QImage(frame.data, w, h, bytes_per_line, QImage.Format.Format_RGB888)
                pixmap = QPixmap.fromImage(qt_image)
                self.thumbnail_label.setPixmap(pixmap.scaled(320, 180, Qt.AspectRatioMode.KeepAspectRatio, Qt.TransformationMode.SmoothTransformation))
        except:
            pass
    
    def show_context_menu(self, pos):
        """顯示?鍵?單"""
        from PyQt6.QtWidgets import QMenu
        menu = QMenu(self)
        
        play_action = menu.addAction("?? 以播?器?放")
        play_action.triggered.connect(self.open_video)
        
        menu.exec(pos)
    
    def open_video(self):
        """?個影片"""
        try:
            os.startfile(str(self.video_path))
        except Exception as e:
            QMessageBox.warning(self, "?誤", f"個檔案個影片: {e}")
    
    def rename_video(self):
        """?命個影片?""
        current_name = self.video_path.stem
        new_name, ok = QInputDialog.getText(
            self,
            "?命個影片?,
            "請輸?新??案??",
            text=current_name
        )
        
        if ok and new_name and new_name != current_name:
            try:
                new_path = self.video_path.parent / f"{new_name}{self.video_path.suffix}"
                
                if new_path.exists():
                    QMessageBox.warning(self, "?誤", "檔案?稱已個檔案")
                    return
                
                self.video_path.rename(new_path)
                self.video_path = new_path
                self.filename_label.setText(new_path.name)
                self.renamed.emit(self)
                
                QMessageBox.information(self, "??", "影?已個檔案!")
            except Exception as e:
                QMessageBox.warning(self, "?誤", f"?命?失?? {e}")
    
    def delete_video(self):
        """?除影?（??確認?"""
        try:
            self.video_path.unlink()  # 刪除檔案
            self.deleted.emit(self)
        except Exception as e:
            QMessageBox.warning(self, "?誤", f"刪除失?: {e}")



class StatCard(QFrame):
    def __init__(self, title, color, is_dark=False):
        super().__init__()
        self.setFrameStyle(QFrame.Shape.StyledPanel)
        bg_color = "#2C2C2E" if is_dark else "white"
        self.setStyleSheet(f"""
            QFrame {{
                background-color: {bg_color};
                border-radius: 8px;
                padding: 8px 12px;
            }}
        """)
        
        layout = QVBoxLayout()
        layout.setSpacing(4)
        layout.setContentsMargins(0, 0, 0, 0)
        
        self.title_label = QLabel(title)
        title_color = "#98989D" if is_dark else "#8E8E93"
        self.title_label.setStyleSheet(f"color: {title_color}; font-size: 10px;")
        
        self.value_label = QLabel("0")
        self.value_label.setStyleSheet(f"color: {color}; font-size: 24px; font-weight: bold;")
        
        layout.addWidget(self.title_label)
        layout.addWidget(self.value_label)
        
        self.setLayout(layout)
    
    def set_value(self, value):
        self.value_label.setText(str(value))


class MainWindow(QMainWindow):
    def __init__(self):
        super().__init__()
        self.cache = {}
        self.load_cache()
        self.processor = None
        self.selected_folder = ""
        
        # Load settings
        self.settings = QSettings("Lucien", APP_NAME)
        self.is_dark = self.settings.value("dark_mode", True, type=bool)
        
        # Initialize version manager
        if VersionManager:
            self.version_manager = VersionManager(GITHUB_REPO, VERSION, logger=self.add_log)
        else:
            self.version_manager = None
        
        self.init_ui()
        self.apply_theme()
        
        # Check for updates on startup
        if self.version_manager:
            self.check_updates_async()
    
    def check_updates_async(self):
        """?步檢查?新"""
        def check():
            time.sleep(2)  # 延遲2秒避個檔案個檔案
            update_info = self.version_manager.check_for_updates()
            if update_info:
                self.show_update_dialog(update_info)
        
        import threading
        threading.Thread(target=check, daemon=True).start()
    
    def show_update_dialog(self, update_info):
        """顯示?新對話?""
        reply = QMessageBox.question(
            self,
            "?現個檔案?,
            f"?現個檔案?{update_info['version']}!\n\n?否立即?新?",
            QMessageBox.StandardButton.Yes | QMessageBox.StandardButton.No
        )
        
        if reply == QMessageBox.StandardButton.Yes:
            self.download_and_install_update(update_info)
    
    def download_and_install_update(self, update_info):
        """下?並?裝更??""
        # ?裡?以?入?度對話?
        zip_path = self.version_manager.download_update(update_info['download_url'])
        if zip_path:
            extract_dir = self.version_manager.extract_update(zip_path)
            if extract_dir:
                if self.version_manager.apply_update(extract_dir, restart_after=True):
                    # 個檔案用程?
                    QApplication.quit()
    
    def init_ui(self):
        self.setWindowTitle(f"? {APP_NAME} v{VERSION}")
        self.setMinimumSize(1000, 650)  # 設??小尺?
        self.resize(1400, 750)  # ?設尺寸（更寬以容個檔案?
        
        self.create_icon()
        
        central_widget = QWidget()
        self.setCentralWidget(central_widget)
        
        # Main horizontal layout
        main_layout = QHBoxLayout()
        main_layout.setContentsMargins(15, 15, 15, 15)
        main_layout.setSpacing(10)
        
        # Left panel (??式寬度?
        left_panel = QWidget()
        left_panel.setMinimumWidth(350)
        left_panel.setMaximumWidth(450)
        left_layout = QVBoxLayout()
        left_layout.setContentsMargins(0, 0, 0, 0)
        left_layout.setSpacing(10)
        
        # Header with theme toggle
        header_layout = QVBoxLayout()
        header_layout.setSpacing(2)
        
        title_row = QHBoxLayout()
        title = QLabel(f"? {APP_NAME}")
        title.setStyleSheet("font-size: 18px; font-weight: bold;")
        title_row.addWidget(title)
        title_row.addStretch()
        
        # Theme toggle
        self.theme_toggle = QCheckBox("?? 深色模?")
        self.theme_toggle.setChecked(self.is_dark)
        self.theme_toggle.setStyleSheet("font-size: 10px;")
        self.theme_toggle.stateChanged.connect(self.toggle_theme)
        title_row.addWidget(self.theme_toggle)
        
        subtitle = QLabel(f"?能影個檔案??工具 v{VERSION}")
        subtitle.setStyleSheet("font-size: 10px;")
        
        header_layout.addLayout(title_row)
        header_layout.addWidget(subtitle)
        
        # Stats cards
        stats_layout = QHBoxLayout()
        stats_layout.setSpacing(6)
        
        self.total_card = StatCard("總?案數", "#007AFF", self.is_dark)
        self.processed_card = StatCard("已個檔案, "#34C759", self.is_dark)
        self.skipped_card = StatCard("已跳??, "#FF9500", self.is_dark)
        self.failed_card = StatCard("失?", "#FF3B30", self.is_dark)
        
        stats_layout.addWidget(self.total_card)
        stats_layout.addWidget(self.processed_card)
        stats_layout.addWidget(self.skipped_card)
        stats_layout.addWidget(self.failed_card)
        
        # Progress
        self.progress_widget = QFrame()
        progress_layout = QVBoxLayout()
        progress_layout.setSpacing(4)
        progress_layout.setContentsMargins(0, 0, 0, 0)
        
        progress_header = QHBoxLayout()
        self.progress_title = QLabel("個檔案度")
        self.progress_title.setStyleSheet("font-size: 11px; font-weight: 600;")
        self.progress_percent = QLabel("0%")
        self.progress_percent.setStyleSheet("font-size: 11px; font-weight: 600; color: #007AFF;")
        progress_header.addWidget(self.progress_title)
        progress_header.addStretch()
        progress_header.addWidget(self.progress_percent)
        
        self.progress_bar = QProgressBar()
        self.progress_bar.setTextVisible(False)
        self.progress_bar.setFixedHeight(6)
        
        self.current_file_label = QLabel("準個檔案...")
        self.current_file_label.setStyleSheet("font-size: 10px;")
        
        progress_layout.addLayout(progress_header)
        progress_layout.addWidget(self.progress_bar)
        progress_layout.addWidget(self.current_file_label)
        self.progress_widget.setLayout(progress_layout)
        
        # Log area
        self.log_widget = QFrame()
        log_layout = QVBoxLayout()
        log_layout.setSpacing(4)
        log_layout.setContentsMargins(0, 0, 0, 0)
        
        self.log_title = QLabel("個檔案?")
        self.log_title.setStyleSheet("font-size: 11px; font-weight: 600;")
        
        self.log_text = QTextEdit()
        self.log_text.setReadOnly(True)
        self.log_text.setStyleSheet("font-family: Consolas; font-size: 9px; border: none; border-radius: 4px; padding: 6px;")
        
        log_layout.addWidget(self.log_title)
        log_layout.addWidget(self.log_text)
        self.log_widget.setLayout(log_layout)
        
        # Control buttons
        control_layout = QVBoxLayout()
        control_layout.setSpacing(6)
        
        folder_layout = QHBoxLayout()
        self.select_folder_btn = QPushButton("?? ??資??)
        self.select_folder_btn.setFixedHeight(32)
        self.select_folder_btn.clicked.connect(self.select_folder)
        folder_layout.addWidget(self.select_folder_btn)
        
        self.folder_path_label = QLabel("?選個檔案夾")
        self.folder_path_label.setStyleSheet("font-size: 9px;")
        self.folder_path_label.setWordWrap(True)
        
        button_layout = QHBoxLayout()
        button_layout.setSpacing(6)
        
        self.start_btn = QPushButton("?? ??")
        self.start_btn.setFixedHeight(32)
        self.start_btn.clicked.connect(self.start_processing)
        
        self.stop_btn = QPushButton("?? ?止")
        self.stop_btn.setFixedHeight(32)
        self.stop_btn.setEnabled(False)
        self.stop_btn.clicked.connect(self.stop_processing)
        
        self.export_btn = QPushButton("? ?出")
        self.export_btn.setFixedHeight(32)
        self.export_btn.clicked.connect(self.export_results)
        
        self.player_btn = QPushButton("?? ?放")
        self.player_btn.setFixedHeight(32)
        self.player_btn.clicked.connect(self.show_multi_player)
        
        self.about_btn = QPushButton("?? ?於")
        self.about_btn.setFixedHeight(32)
        self.about_btn.clicked.connect(self.show_about)
        
        button_layout.addWidget(self.start_btn)
        button_layout.addWidget(self.stop_btn)
        button_layout.addWidget(self.export_btn)
        button_layout.addWidget(self.player_btn)
        button_layout.addWidget(self.about_btn)
        
        control_layout.addLayout(folder_layout)
        control_layout.addWidget(self.folder_path_label)
        control_layout.addLayout(button_layout)
        
        # Add to left panel
        left_layout.addLayout(header_layout)
        left_layout.addLayout(stats_layout)
        left_layout.addWidget(self.progress_widget)
        left_layout.addWidget(self.log_widget, 1)
        left_layout.addLayout(control_layout)
        left_panel.setLayout(left_layout)
        
        # Right panel - Video list
        self.right_panel = QFrame()
        
        right_layout = QVBoxLayout()
        right_layout.setSpacing(4)
        right_layout.setContentsMargins(0, 0, 0, 0)
        
        list_header = QHBoxLayout()
        self.list_title = QLabel("影??表")
        self.list_title.setStyleSheet("font-size: 11px; font-weight: 600;")
        
        self.list_hint = QLabel("滑個檔案個檔案覽 | 點??放個檔案個影片")
        self.list_hint.setStyleSheet("font-size: 9px;")
        
        list_header.addWidget(self.list_title)
        list_header.addStretch()
        list_header.addWidget(self.list_hint)
        
        # 影片?表（使?網??局實現??顯示?
        scroll_area = QScrollArea()
        scroll_area.setWidgetResizable(True)
        scroll_area.setHorizontalScrollBarPolicy(Qt.ScrollBarPolicy.ScrollBarAlwaysOff)
        
        # ?建網格容器
        self.video_grid_widget = QWidget()
        self.video_grid_layout = QGridLayout()
        self.video_grid_layout.setSpacing(8)
        self.video_grid_layout.setContentsMargins(4, 4, 4, 4)
        self.video_grid_widget.setLayout(self.video_grid_layout)
        
        scroll_area.setWidget(self.video_grid_widget)
        
        right_layout.addLayout(list_header)
        right_layout.addWidget(scroll_area)
        self.right_panel.setLayout(right_layout)
        
        # Add panels to main layout
        main_layout.addWidget(left_panel)
        main_layout.addWidget(self.right_panel, 1)
        
        central_widget.setLayout(main_layout)
        
        self.add_log(f"ChroLens_AutoFlow v{VERSION} 已個檔案)
        self.add_log("已??快?? {} 個檔案?.format(len(self.cache)))
    
    def apply_theme(self):
        if self.is_dark:
            # Dark theme
            self.setStyleSheet("""
                QMainWindow { background-color: #1C1C1E; }
                QWidget { color: #E5E5EA; }
                QLabel { color: #E5E5EA; }
                QCheckBox { color: #E5E5EA; }
            """)
            
            self.progress_widget.setStyleSheet("""
                QFrame {
                    background-color: #2C2C2E;
                    border-radius: 8px;
                    padding: 8px 12px;
                }
            """)
            
            self.log_widget.setStyleSheet("""
                QFrame {
                    background-color: #2C2C2E;
                    border-radius: 8px;
                    padding: 8px;
                }
            """)
            
            self.right_panel.setStyleSheet("""
                QFrame {
                    background-color: #2C2C2E;
                    border-radius: 8px;
                    padding: 8px;
                }
            """)
            
            self.log_text.setStyleSheet("""
                QTextEdit {
                    background-color: #1C1C1E;
                    color: #E5E5EA;
                    border: none;
                    border-radius: 4px;
                    padding: 6px;
                    font-family: Consolas;
                    font-size: 9px;
                }
            """)
            
            
            
            self.progress_bar.setStyleSheet("""
                QProgressBar {
                    border: none;
                    background-color: #3A3A3C;
                    border-radius: 3px;
                    height: 6px;
                }
                QProgressBar::chunk {
                    background-color: #007AFF;
                    border-radius: 3px;
                }
            """)
            
            btn_style = """
                QPushButton {
                    background-color: #3A3A3C;
                    color: #E5E5EA;
                    border: none;
                    border-radius: 6px;
                    padding: 6px 16px;
                    font-size: 11px;
                    font-weight: 600;
                    min-width: 70px;
                }
                QPushButton:hover {
                    background-color: #48484A;
                }
                QPushButton:disabled {
                    background-color: #2C2C2E;
                    color: #636366;
                }
            """
            
            start_btn_style = """
                QPushButton {
                    background-color: #007AFF;
                    color: white;
                    border: none;
                    border-radius: 6px;
                    padding: 6px 16px;
                    font-size: 11px;
                    font-weight: 600;
                    min-width: 70px;
                }
                QPushButton:hover {
                    background-color: #0051D5;
                }
                QPushButton:disabled {
                    background-color: #2C2C2E;
                    color: #636366;
                }
            """
            
        else:
            # Light theme
            self.setStyleSheet("QMainWindow { background-color: #F5F5F7; }")
            
            self.progress_widget.setStyleSheet("""
                QFrame {
                    background-color: white;
                    border-radius: 8px;
                    padding: 8px 12px;
                }
            """)
            
            self.log_widget.setStyleSheet("""
                QFrame {
                    background-color: white;
                    border-radius: 8px;
                    padding: 8px;
                }
            """)
            
            self.right_panel.setStyleSheet("""
                QFrame {
                    background-color: white;
                    border-radius: 8px;
                    padding: 8px;
                }
            """)
            
            self.log_text.setStyleSheet("""
                QTextEdit {
                    background-color: #F5F5F7;
                    color: #3A3A3C;
                    border: none;
                    border-radius: 4px;
                    padding: 6px;
                    font-family: Consolas;
                    font-size: 9px;
                }
            """)
            
            
            
            self.progress_bar.setStyleSheet("""
                QProgressBar {
                    border: none;
                    background-color: #E5E5EA;
                    border-radius: 3px;
                    height: 6px;
                }
                QProgressBar::chunk {
                    background-color: #007AFF;
                    border-radius: 3px;
                }
            """)
            
            btn_style = """
                QPushButton {
                    background-color: #E5E5EA;
                    color: #1C1C1E;
                    border: none;
                    border-radius: 6px;
                    padding: 6px 16px;
                    font-size: 11px;
                    font-weight: 600;
                    min-width: 70px;
                }
                QPushButton:hover {
                    background-color: #D1D1D6;
                }
                QPushButton:disabled {
                    background-color: #C7C7CC;
                    color: #8E8E93;
                }
            """
            
            start_btn_style = """
                QPushButton {
                    background-color: #007AFF;
                    color: white;
                    border: none;
                    border-radius: 6px;
                    padding: 6px 16px;
                    font-size: 11px;
                    font-weight: 600;
                    min-width: 70px;
                }
                QPushButton:hover {
                    background-color: #0051D5;
                }
                QPushButton:disabled {
                    background-color: #C7C7CC;
                    color: #8E8E93;
                }
            """
        
        self.select_folder_btn.setStyleSheet(btn_style)
        self.stop_btn.setStyleSheet(btn_style)
        self.export_btn.setStyleSheet(btn_style)
        self.about_btn.setStyleSheet(btn_style)
        self.start_btn.setStyleSheet(start_btn_style)
    
    def toggle_theme(self, state):
        self.is_dark = state == Qt.CheckState.Checked.value
        self.settings.setValue("dark_mode", self.is_dark)
        self.apply_theme()
        
        # Reload video list
        if self.selected_folder:
            self.load_video_list()
    
    def show_about(self):
        if VersionInfoDialog:
            dialog = VersionInfoDialog(self, self.version_manager, VERSION, FULL_APP_NAME)
            dialog.exec()
        elif AboutDialog:
            dialog = AboutDialog(self, self.is_dark, VERSION, FULL_APP_NAME)
            dialog.exec()
        else:
            QMessageBox.information(
                self,
                "?於",
                f"{FULL_APP_NAME} v{VERSION}\n\n?能影個檔案??工具\n\n© 2026 Lucien"
            )
    
    def create_icon(self):
        pixmap = QPixmap(256, 256)
        pixmap.fill(QColor("#007AFF"))
        icon = QIcon(pixmap)
        self.setWindowIcon(icon)
    
    def load_cache(self):
        cache_file = Path.home() / "Downloads" / "actress_cache.json"
        if cache_file.exists():
            try:
                with open(cache_file, 'r', encoding='utf-8') as f:
                    self.cache = json.load(f)
                    self.cache = {k: v for k, v in self.cache.items() if v != "如?系統沒?"}
            except Exception as e:
                print(f"快?載入失?: {e}")
    
    def select_folder(self):
        folder = QFileDialog.getExistingDirectory(self, "?個影片資??)
        if folder:
            self.selected_folder = folder
            self.folder_path_label.setText(folder)
            self.add_log(f"已選個檔案夾: {folder}")
            self.load_video_list()
    
    def load_video_list(self):
        
        if not self.selected_folder:
            return
        
        files = list(Path(self.selected_folder).glob("*.mp4"))
        self.add_log(f"載入 {len(files)} ?影個檔案)")
        
        # 清空個檔案網?內?
        for i in reversed(range(self.video_grid_layout.count())):
            widget = self.video_grid_layout.itemAt(i).widget()
            if widget:
                widget.deleteLater()
        
        # 以兩欄個檔案添個影片
        for index, file_path in enumerate(files[:50]):
            widget = VideoListItem(file_path, self.is_dark, self)
            
            # 個檔案除信?
            widget.deleted.connect(lambda w=widget: self.on_video_deleted_grid(w))
            # 個檔案命?信??
            widget.renamed.connect(lambda w=widget: self.on_video_renamed(w))
            
            # 計?行個檔案??佈??
            row = index // 2
            col = index % 2
            self.video_grid_layout.addWidget(widget, row, col)
    
    def on_video_deleted_grid(self, widget):
        """??網格中個影片?除事件"""
        self.video_grid_layout.removeWidget(widget)
        widget.deleteLater()
        self.add_log(f"已刪個影片? {widget.video_path.name}")
    
    def on_video_deleted(self, widget, item):
        """?個影片?除事件"""
        row = self.video_list.row(item)
        self.video_list.takeItem(row)
        self.add_log(f"已刪個影片? {widget.video_path.name}")
    
    def on_video_renamed(self, widget):
        """?個影片?命個檔案""
        self.add_log(f"已個檔案影片: {widget.video_path.name}")
    
    def start_processing(self):
        if not self.selected_folder:
            self.add_log("[?誤] 請個檔案資??)
            return
        
        self.start_btn.setEnabled(False)
        self.stop_btn.setEnabled(True)
        self.select_folder_btn.setEnabled(False)
        
        self.processor = VideoProcessor(self.selected_folder, self.cache)
        self.processor.progress_update.connect(self.update_stats)
        self.processor.log_update.connect(self.add_log)
        self.processor.current_file_update.connect(self.update_current_file)
        self.processor.finished.connect(self.processing_finished)
        self.processor.start()
    
    def stop_processing(self):
        if self.processor:
            self.processor.stop()
            self.add_log("??止??...")
    
    def processing_finished(self):
        self.start_btn.setEnabled(True)
        self.stop_btn.setEnabled(False)
        self.select_folder_btn.setEnabled(True)
        self.load_video_list()
    
    def update_stats(self, total, processed, skipped, failed):
        self.total_card.set_value(total)
        self.processed_card.set_value(processed)
        self.skipped_card.set_value(skipped)
        self.failed_card.set_value(failed)
        
        if total > 0:
            progress = int((processed + skipped + failed) / total * 100)
            self.progress_bar.setValue(progress)
            self.progress_percent.setText(f"{progress}%")
    
    def update_current_file(self, filename):
        self.current_file_label.setText(filename)
    
    def add_log(self, message):
        timestamp = time.strftime("%H:%M:%S")
        self.log_text.append(f"[{timestamp}] {message}")
    
    def export_results(self):
        if not self.cache:
            self.add_log("[?誤] 沒?資??匯??)
            return
        
        filename, _ = QFileDialog.getSaveFileName(
            self, "?出結?", 
            f"actress_results_{time.strftime('%Y%m%d_%H%M%S')}.csv",
            "CSV Files (*.csv)"
        )
        
        if filename:
            try:
                with open(filename, 'w', encoding='utf-8-sig') as f:
                    f.write("Video Code,Actress Name\n")
                    for code, actress in self.cache.items():
                        f.write(f"{code},{actress}\n")
                self.add_log(f"[??] 已匯找到: {filename}")
            except Exception as e:
                self.add_log(f"[錯誤] ?出失?: {str(e)}")
    
    def show_multi_player(self):
        """顯示多?窗播?器"""
        if not self.selected_folder:
            QMessageBox.warning(self, "?示", "請個檔案影?資?夾?")
            return
        
        files = list(Path(self.selected_folder).glob("*.mp4"))
        if not files:
            QMessageBox.warning(self, "?示", "資?夾中沒個影片檔案?)
            return
        
        # ?建並顯示?視??放??
        player = MultiPlayerWindow(files, self.is_dark, self)
        player.show()
        self.add_log(f"已個檔案視??放個檔案?{len(files)} 個影片?)")


# 多?窗播?器類別
class MultiPlayerWindow(QDialog):
    def __init__(self, video_files, is_dark=True, parent=None):
        super().__init__(parent)
        self.video_files = video_files
        self.is_dark = is_dark
        self.current_players = [None, None, None, None]  # 4?播?器
        
        self.init_ui()
    
    def init_ui(self):
        self.setWindowTitle("? 多?窗播?器")
        # 4??1280x720 個檔案= 2560x1440，?上左??表個檔案
        self.resize(2900, 1500)
        
        main_layout = QHBoxLayout()
        main_layout.setSpacing(10)
        main_layout.setContentsMargins(10, 10, 10, 10)
        
        # 左側：影個檔案
        left_panel = QWidget()
        left_panel.setMaximumWidth(300)
        left_layout = QVBoxLayout()
        
        list_label = QLabel("影??表")
        list_label.setStyleSheet("font-size: 14px; font-weight: bold;")
        
        self.video_list = QListWidget()
        self.video_list.setStyleSheet("""
            QListWidget {
                background-color: #2C2C2E;
                border-radius: 8px;
                padding: 4px;
            }
            QListWidget::item {
                padding: 8px;
                border-radius: 4px;
                margin: 2px;
            }
            QListWidget::item:hover {
                background-color: #3A3A3C;
            }
            QListWidget::item:selected {
                background-color: #007AFF;
            }
        """)
        
        for video_file in self.video_files:
            self.video_list.addItem(video_file.name)
        
        self.video_list.itemDoubleClicked.connect(self.on_video_double_clicked)
        
        left_layout.addWidget(list_label)
        left_layout.addWidget(self.video_list)
        left_panel.setLayout(left_layout)
        
        # ?側??播??框?2x2網格?
        right_panel = QWidget()
        grid_layout = QGridLayout()
        grid_layout.setSpacing(10)
        
        # ?建4?播個檔案
        self.player_frames = []
        for i in range(4):
            frame = QLabel(f"?放??{i+1}\n\n??左側影片?表?放")
            frame.setFixedSize(1280, 720)
            frame.setStyleSheet("""
                QLabel {
                    background-color: #1C1C1E;
                    border: 2px solid #3A3A3C;
                    border-radius: 8px;
                    color: #8E8E93;
                    font-size: 16px;
                }
            """)
            frame.setAlignment(Qt.AlignmentFlag.AlignCenter)
            frame.setScaledContents(True)
            
            row = i // 2
            col = i % 2
            grid_layout.addWidget(frame, row, col)
            self.player_frames.append(frame)
        
        right_panel.setLayout(grid_layout)
        
        main_layout.addWidget(left_panel)
        main_layout.addWidget(right_panel, 1)
        
        self.setLayout(main_layout)
    
    def on_video_double_clicked(self, item):
        """?個影片?表?目?播??""
        video_index = self.video_list.row(item)
        video_path = self.video_files[video_index]
        
        # 找到第??空個檔案放??
        for i, frame in enumerate(self.player_frames):
            if self.current_players[i] is None:
                self.play_video_in_frame(i, video_path)
                return
        
        # 如??在?放，使?第一??
        self.play_video_in_frame(0, video_path)
    
    def play_video_in_frame(self, frame_index, video_path):
        """??定?框中?放影?"""
        try:
            # 載入影片?第一幀作為?覽
            cap = cv2.VideoCapture(str(video_path))
            ret, frame = cap.read()
            cap.release()
            
            if ret:
                frame = cv2.cvtColor(frame, cv2.COLOR_BGR2RGB)
                h, w, ch = frame.shape
                bytes_per_line = ch * w
                qt_image = QImage(frame.data, w, h, bytes_per_line, QImage.Format.Format_RGB888)
                pixmap = QPixmap.fromImage(qt_image)
                self.player_frames[frame_index].setPixmap(pixmap)
                self.player_frames[frame_index].setText("")
                
                # 使用系統?放?播??實??放?
                os.startfile(str(video_path))
                
                self.current_players[frame_index] = video_path.name
        except Exception as e:
            print(f"?放失?: {e}")


if __name__ == '__main__':
    app = QApplication(sys.argv)
    app.setStyle('Fusion')
    
    font = QFont("Segoe UI", 9)
    app.setFont(font)
    
    window = MainWindow()
    window.show()
    sys.exit(app.exec())
